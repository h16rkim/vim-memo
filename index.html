<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vim Memo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f4f4f4;
        }
        .editor {
            width: 80%;
            height: 80vh;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow-y: auto;
            background: white;
        }
        .CodeMirror {
            height: 100% !important;
        }
        .controls {
            margin-top: 10px;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            width: 80%;
        }
    </style>
    <!-- CodeMirror -->
    <link rel="stylesheet" href="codemirror/5.65.9/codemirror.min.css">
    <script src="codemirror/5.65.9/codemirror.min.js"></script>
    <script src="codemirror/5.65.9/keymap/vim.min.js"></script>
    <script src="codemirror/5.65.9/extensions/match-brackets.js"></script>
    <script src="codemirror/5.65.9/extensions/format.js"></script>
    <script src="codemirror/5.65.9/extensions/css.js"></script>
    <script src="codemirror/5.65.9/extensions/xml.js"></script>
    <script src="codemirror/5.65.9/extensions/javascript.js"></script>
    <script src="codemirror/5.65.9/extensions/htmlmixed.js"></script>
    <script src="codemirror/5.65.9/extensions/sql.js"></script>
    <script src="codemirror/5.65.9/extensions/clike.min.js"></script>

</head>
<body>

<div class="controls">
    <input type="text" class="title-input" id="title-input" placeholder="Enter document title...">
    <select id="mode-select">
        <option value="text">Plain</option>
        <option value="text/x-sql">SQL</option>
        <option value="application/json">JSON</option>
        <option value="application/xml">XML</option>
        <option value="text/typescript">TypeScript</option>
        <option value="javascript">JavaScript</option>
        <option value="text/x-kotlin">Kotlin</option>
        <option value="text/x-java">Java</option>
        <option value="htmlmixed">HTML</option>
        <option value="markdown">Markdown</option>
    </select>
    <button class="button" id="format-button">Format</button>
    <button class="button" id="download-button">Download</button>
    <button class="button" id="save-button">Save</button>
    <button class="button" id="new-button">New</button>

</div>
<div class="editor" id="editor"></div>

<script>
    // Initialize CodeMirror with Vim key bindings
    const STORAGE_KEY = 'h16rkim_vim_memo';

    const editor = CodeMirror(document.getElementById('editor'), {
        mode: "text",
        lineNumbers: true,
        keyMap: 'vim',
        viewportMargin: Infinity
    });

    function getSelectedRange() {
        const from = editor.getCursor(true);
        const to = editor.getCursor(false);
        // If no selection, select the entire document
        if (from.line === to.line && from.ch === to.ch) {
            return { from: { line: 0, ch: 0 }, to: { line: editor.lastLine(), ch: editor.getLine(editor.lastLine()).length } };
        }
        return { from, to };
    }

    function autoFormatSelection() {
        var range = getSelectedRange();
        editor.autoFormatRange(range.from, range.to);
    }

    function commentSelection() {
        var range = getSelectedRange();
        const isComment = editor.getLine(range.from.line).trim().startsWith('//') || editor.getLine(range.from.line).trim().startsWith('<!--') || editor.getLine(range.from.line).trim().startsWith('/*') || editor.getLine(range.from.line).trim().startsWith('--');
        editor.commentRange(!isComment, range.from, range.to);
    }

    function download() {
        const markdownText = editor.getValue();
        const fileName = prompt("Enter the file name", `notes-${getCurrentTimestamp()}.txt`);

        if (fileName) {
            const blob = new Blob([markdownText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();

            URL.revokeObjectURL(url);
        }
    }

    function getCurrentTimestamp() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0'); // 월은 0부터 시작하므로 +1
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${year}${month}${day}${hours}${minutes}${seconds}`;
    }

    function newMemo() {
        const currentURL = window.location.href;
        window.open(currentURL);
    }

    function save() {
        const content = editor.getValue();
        localStorage.setItem(STORAGE_KEY, content);
    }

    function load() {
        const content = localStorage.getItem(STORAGE_KEY);
        if (content) {
            editor.setValue(content);
        }
    }

    // Add event listener to the format button
    document.getElementById('format-button').addEventListener('click', autoFormatSelection);
    // Download Markdown content with user-defined filename
    document.getElementById('download-button').addEventListener('click', download);
    // Save Memo to Cookie
    document.getElementById('save-button').addEventListener('click', save);
    // New Memo Tab
    document.getElementById('new-button').addEventListener('click', newMemo);
    // Update mode based on the select box
    document.getElementById('mode-select').addEventListener('change', function(event) {
        const mode = event.target.value;
        editor.setOption('mode', mode);
    });
    // Update document title based on input field
    document.getElementById('title-input').addEventListener('input', function(event) {
        document.title = event.target.value || 'Markdown Notes (Vim)';
    });

    // Add event listener for CMD+/ to toggle comments
    editor.addKeyMap({
        'Cmd-/': function() {
            commentSelection(true);
        },
        'Cmd-A': function() {
            editor.setSelection({ line: 0, ch: 0 }, { line: editor.lastLine(), ch: editor.getLine(editor.lastLine()).length });
        }
    });

    // Automatically switch to insert mode on load and focus the editor
    window.addEventListener('load', () => {
        editor.focus();
        CodeMirror.Vim.handleKey(editor, 'i');
        load();
    });

</script>
</body>
</html>
